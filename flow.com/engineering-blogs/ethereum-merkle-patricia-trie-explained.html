<!DOCTYPE html><!-- This site was created in Webflow. https://www.webflow.com --><!-- Last Published: Mon Jul 17 2023 22:17:53 GMT+0000 (Coordinated Universal Time) --><html data-wf-domain="flow-com.webflow.io" data-wf-page="637380c394c328ab5ad74bb3" data-wf-site="5f734f4dbd95382f4fdfa0ea" lang="en">
<!-- Mirrored from flow.com/engineering-blogs/ethereum-merkle-patricia-trie-explained by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Jul 2023 16:25:06 GMT -->
<head><meta charset="utf-8"/><title>Ethereum Merkle Patricia Trie Explained</title><meta content="Aug 12, 2022" name="description"/><meta content="Ethereum Merkle Patricia Trie Explained" property="og:title"/><meta content="Aug 12, 2022" property="og:description"/><meta content="" property="og:image"/><meta content="Ethereum Merkle Patricia Trie Explained" property="twitter:title"/><meta content="Aug 12, 2022" property="twitter:description"/><meta content="" property="twitter:image"/><meta property="og:type" content="website"/><meta content="summary_large_image" name="twitter:card"/><meta content="width=device-width, initial-scale=1" name="viewport"/><meta content="goOrjM0FiQtmK2lUJ9Y5NpPJA-fMUUc_6Q6Vmd7-XIY" name="google-site-verification"/><meta content="Webflow" name="generator"/><link href="../../assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/css/flow-com.webflow.9325b97a3.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/" rel="preconnect"/><link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="anonymous"/><script src="../../ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script><script type="text/javascript">WebFont.load({  google: {    families: ["Epilogue:300,regular,500,600,700,800,900,italic"]  }});</script><script src="../../use.typekit.net/mgu2ukv.js" type="text/javascript"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="../../assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/616b1520779838b5f9174363_favicon.png" rel="shortcut icon" type="image/x-icon"/><link href="../../assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/616b1548fd01d005fc2bc2c7_logo256.png" rel="apple-touch-icon"/><link href="ethereum-merkle-patricia-trie-explained.html" rel="canonical"/><style>
  .w-webflow-badge {
    display: none !important;
  }
</style>


<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'../../www.googletagmanager.com/gtm5445.html?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PWSGFLB');</script>
<!-- End Google Tag Manager -->


<meta name="facebook-domain-verification" content="dhlb5fcuitl7owilmsg6xh307ohoyc" />

<!-- Hotjar Tracking Code for Flow.com -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:3329982,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
<link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" /></head><body><div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navigation w-nav"><div class="nav-container w-container"><a href="../index.html" class="nav-logo-div w-nav-brand"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63ce603ae36f46f6bb67e51e_flow-logo.svg" loading="lazy" alt="flow logo" class="hide"/><div aria-label="Flow logo" class="nav-logo__embed w-embed"><svg width="100" height="42" viewBox="0 0 100 42" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_106_24812)">
<path class="logotype" d="M57.3672 20.9501H54.6797V30.971H50.9297V20.9501H48.9922V17.7376H50.9297V16.4876C50.9297 13.2501 52.9505 11.5876 56.0214 11.5876C56.4968 11.5916 56.9705 11.6475 57.4339 11.7543V15.5043C57.0296 15.3422 56.5985 15.2574 56.163 15.2543C55.9663 15.2387 55.7684 15.2659 55.5832 15.334C55.3979 15.4021 55.2296 15.5096 55.0899 15.6489C54.9501 15.7883 54.8422 15.9563 54.7735 16.1414C54.7049 16.3264 54.6771 16.5242 54.6922 16.721V17.7168H57.3797L57.3672 20.9501ZM63.013 30.971H59.2214V11.871H63.013V30.971Z" fill="black"/>
<path class="logotype" d="M71.4292 16.9085C72.851 16.906 74.2415 17.3255 75.4247 18.1139C76.6079 18.9023 77.5306 20.024 78.0758 21.3371C78.6211 22.6502 78.7644 24.0956 78.4876 25.4902C78.2108 26.8848 77.5264 28.1658 76.5211 29.1712C75.5157 30.1766 74.2346 30.861 72.84 31.1377C71.4454 31.4145 70.0001 31.2712 68.687 30.726C67.3739 30.1807 66.2521 29.2581 65.4638 28.0749C64.6754 26.8917 64.2559 25.5011 64.2584 24.0793C64.2466 23.1344 64.4241 22.1967 64.7803 21.3213C65.1365 20.446 65.6642 19.6508 66.3325 18.9826C67.0007 18.3144 67.7959 17.7866 68.6712 17.4304C69.5465 17.0742 70.4842 16.8968 71.4292 16.9085V16.9085ZM71.4292 27.596C73.3667 27.596 74.7625 25.9877 74.7625 24.0793C74.7834 23.6288 74.7126 23.1787 74.5544 22.7563C74.3963 22.3339 74.1541 21.9481 73.8424 21.622C73.5308 21.296 73.1562 21.0366 72.7414 20.8595C72.3266 20.6824 71.8802 20.5914 71.4292 20.5918C70.5213 20.6232 69.661 21.0058 69.0298 21.6592C68.3986 22.3125 68.0458 23.1855 68.0458 24.0939C68.0458 25.0024 68.3986 25.8753 69.0298 26.5286C69.661 27.182 70.5213 27.5647 71.4292 27.596Z" fill="black"/>
<path class="logotype" d="M82.5576 17.1875L84.9951 26.3542L87.4326 19.0708L86.7659 17.1917H90.5159L93.7284 26.3583L96.1076 17.1917H99.9992L95.9034 30.975H91.9701L89.2284 23.4167L86.6659 30.9708H82.7076L78.6367 17.1875H82.5576Z" fill="black"/>
<path d="M20.8333 41.8334C32.3393 41.8334 41.6667 32.506 41.6667 21.0001C41.6667 9.49415 32.3393 0.166748 20.8333 0.166748C9.3274 0.166748 0 9.49415 0 21.0001C0 32.506 9.3274 41.8334 20.8333 41.8334Z" fill="#00EF8B"/>
<path d="M29.9732 17.7417H24.0898V23.625H29.9732V17.7417Z" fill="white"/>
<path d="M18.2138 25.8292C18.2138 26.266 18.0843 26.6929 17.8416 27.0561C17.599 27.4192 17.2541 27.7023 16.8506 27.8694C16.447 28.0366 16.003 28.0803 15.5746 27.9951C15.1463 27.9099 14.7528 27.6996 14.4439 27.3907C14.1351 27.0819 13.9248 26.6884 13.8396 26.26C13.7544 25.8316 13.7981 25.3876 13.9652 24.9841C14.1324 24.5806 14.4154 24.2357 14.7786 23.993C15.1417 23.7504 15.5687 23.6209 16.0055 23.6209H18.2138V17.7417H16.0055C14.4059 17.7417 12.8423 18.216 11.5123 19.1047C10.1823 19.9934 9.14572 21.2564 8.5336 22.7342C7.92147 24.212 7.76131 25.8382 8.07337 27.407C8.38543 28.9758 9.15569 30.4169 10.2867 31.5479C11.4178 32.679 12.8589 33.4492 14.4277 33.7613C15.9965 34.0733 17.6226 33.9132 19.1004 33.3011C20.5782 32.6889 21.8413 31.6523 22.73 30.3224C23.6186 28.9924 24.093 27.4287 24.093 25.8292V23.6209H18.2138V25.8292Z" fill="white"/>
<path d="M26.2984 14.8001H32.9151V8.91675H26.2984C24.1542 8.91895 22.0984 9.77174 20.5821 11.288C19.0659 12.8042 18.2131 14.86 18.2109 17.0042V17.7417H24.0901V17.0042C24.0912 16.4193 24.3244 15.8587 24.7384 15.4454C25.1524 15.0322 25.7135 14.8001 26.2984 14.8001V14.8001Z" fill="white"/>
<path d="M18.2109 23.6209H24.0901V17.7417H18.2109V23.6209Z" fill="#00EF8B"/>
</g>
<defs>
<clipPath id="clip0_106_24812">
<rect width="100" height="41.6666" fill="white" transform="translate(0 0.166748)"/>
</clipPath>
</defs>
</svg></div></a><nav role="navigation" class="new-navigation-menu w-nav-menu"><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Solutions</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list w-dropdown-list"><a href="../hybrid-custody.html" class="navigation-dropdown-link w-dropdown-link">Walletless Onboarding +Hybrid Custody</a><a href="http://developers.flow.com/hybrid-custody/guides/account-abstraction" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Account Abstraction</a><a href="https://developers.flow.com/cadence" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Cadence</a></nav></div><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Developers</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list w-dropdown-list"><a href="https://developers.flow.com/" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Developer portal</a><a href="https://github.com/onflow" class="navigation-dropdown-link w-dropdown-link">GitHub</a></nav></div><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Ecosystem</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list ecosystem w-dropdown-list"><a href="https://www.flowverse.co/" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Flowverse</a></nav></div><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Community</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list community w-dropdown-list"><a href="../flow-ambassador-program.html" class="navigation-dropdown-link w-dropdown-link">Ambassador program</a><a href="../blog.html" class="navigation-dropdown-link w-dropdown-link">Blog</a><a href="https://forum.onflow.org/" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Forum</a><a href="https://discord.com/invite/J6fFnh2xx6" target="_blank" class="navigation-dropdown-link discord w-dropdown-link">Discord</a><a href="https://twitter.com/flow_blockchain" class="navigation-dropdown-link twitter w-dropdown-link">Twitter</a></nav></div><div data-hover="false" data-delay="100" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">About</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list ecosystem w-dropdown-list"><a href="../primer.html" class="navigation-dropdown-link w-dropdown-link">Primer</a><a href="../priorities.html" class="navigation-dropdown-link w-dropdown-link">Priorities</a><a href="../use-cases.html" class="navigation-dropdown-link w-dropdown-link">Use Cases</a><a href="../flow-token-economics.html" class="navigation-dropdown-link w-dropdown-link">Token economics</a><a href="../technical-paper.html" class="navigation-dropdown-link w-dropdown-link">Technical papers</a><a href="../sustainability.html" class="navigation-dropdown-link w-dropdown-link">Sustainability</a></nav></div></nav><div class="new-menu-button w-nav-button"><div class="w-icon-nav-menu"></div></div></div></div><div><div class="post-with-image-layout"><div class="blog-post-hero-2 wf-section"><div class="post-container w-container"><div><div class="blog-post-meta-data in-post"><div class="w-dyn-list"><div role="list" class="eng-blog-category-list w-dyn-items"><div role="listitem" class="w-dyn-item"><a href="../engineering-categories/blockchain.html" class="radius-text w-inline-block"><div class="eco-text-2">Blockchain</div></a></div></div></div><div class="small-dot-sep inpost left"></div><div class="blog-post-meta-text-data">August 12, 2022</div></div><div class="main-blog-post-title">Ethereum Merkle Patricia Trie Explained</div><div class="blog-post-meta-data post"><a href="../authors/leo-zhang.html" class="blog-post-meta-text-data dark">Leo Zhang</a><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Flow Builder</div></div></div></div></div><div class="blog-post-section wf-section"><div class="container-25 _1280 w-container"><div class="post-info-parent"><div class="post-share-sidebar"><div class="social-share-btn-2 tw"></div><div class="social-share-btn-2 email"></div><div class="share-text">Share</div></div><div class="post-main-info-div eng"><img loading="lazy" src="#" alt="Ethereum Merkle Patricia Trie Explained" class="blog-post-main-image w-dyn-bind-empty"/><div class="blog-post-rich-text-block w-richtext"><h3>Introduction</h3><p>Merkle Patricia Trie is one of the key data structures for the Ethereum’s storage layer. I wanted to understand how exactly it works. So I did a deep research on all the materials I could find and implemented the algorithm myself.</p><p>In this block post, I’ll share what I have learned. Explain how exactly Merkle Patricia Trie works, and show you a demo of how a merkle proof is generated and verified.</p><p>The source code of the algorithm and the examples used in this blog post are all open sourced.</p><p>‍</p><h4>zhangchiqing/merkle-patricia-trie</h4><p>This is a simplified implementation of Ethereum&#x27;s modified Merkle Patricia Trie based on the Ethereum&#x27;s yellow paper…</p><p>github.com</p><p>‍</p><p>OK, let’s get started.</p><p>‍</p><h3>A basic key-value mapping</h3><p>Ethereum’s Merkle Patricia Trie is essentially a key-value mapping that provides the following standard methods:</p><div class="w-embed"><pre><code class="language-markup"><!--
type Trie interface {
  // methods as a basic key-value mapping
  Get(key []byte) ([]byte, bool) {
  Put(key []byte, value []byte)
  Del(key []byte, value []byte) bool
}
}--!></code></pre></div><p>An implementation of the above Trie interface should pass the following test cases:</p><div class="w-embed"><pre><code class="language-markup"><!--
func TestGetPut(t *testing.T) {
	t.Run("should get nothing if key does not exist", func(t *testing.T) {
		trie := NewTrie()
		_, found := trie.Get([]byte("notexist"))
		require.Equal(t, false, found)
	})

	t.Run("should get value if key exist", func(t *testing.T) {
		trie := NewTrie()
		trie.Put([]byte{1, 2, 3, 4}, []byte("hello"))
		val, found := trie.Get([]byte{1, 2, 3, 4})
		require.Equal(t, true, found)
		require.Equal(t, val, []byte("hello"))
	})

	t.Run("should get updated value", func(t *testing.T) {
		trie := NewTrie()
		trie.Put([]byte{1, 2, 3, 4}, []byte("hello"))
		trie.Put([]byte{1, 2, 3, 4}, []byte("world"))
		val, found := trie.Get([]byte{1, 2, 3, 4})
		require.Equal(t, true, found)
		require.Equal(t, val, []byte("world"))
	})
}
}--!></code></pre></div><p>(Test cases in this tutorial are included <a href="https://github.com/zhangchiqing/merkle-patricia-trie" target="_blank">in the repo</a> and passed.)</p><p>‍</p><h3>Verify Data Integrity</h3><p>What is merkle patricia trie different from a standard mapping?</p><p>Well, merkle patricia trie allows us to verify data integrity. (For the rest of this tutorial, we will call it trie for simplicity)</p><p>One can compute the Merkle Root Hash of the trie with the Hash function, such that if any key-value pair was updated, the merkle root hash of the trie would be different; if two Tries have the identical key-value pairs, they should have the same merkle root hash.</p><div class="w-embed"><pre><code class="language-markup"><!--
type Trie interface {
  // compute the merkle root hash for verifying data integrity
  Hash() []byte
}
}--!></code></pre></div><p>Let’s explain this behavior with some test cases:</p><div class="w-embed"><pre><code class="language-markup"><!--
// verify data integrity
func TestDataIntegrity(t *testing.T) {
	t.Run("should get a different hash if a new key-value pair was added or updated", func(t *testing.T) {
		trie := NewTrie()
		hash0 := trie.Hash()

		trie.Put([]byte{1, 2, 3, 4}, []byte("hello"))
		hash1 := trie.Hash()

		trie.Put([]byte{1, 2}, []byte("world"))
		hash2 := trie.Hash()

		trie.Put([]byte{1, 2}, []byte("trie"))
		hash3 := trie.Hash()

		require.NotEqual(t, hash0, hash1)
		require.NotEqual(t, hash1, hash2)
		require.NotEqual(t, hash2, hash3)
	})

	t.Run("should get the same hash if two tries have the identicial key-value pairs", func(t *testing.T) {
		trie1 := NewTrie()
		trie1.Put([]byte{1, 2, 3, 4}, []byte("hello"))
		trie1.Put([]byte{1, 2}, []byte("world"))

		trie2 := NewTrie()
		trie2.Put([]byte{1, 2, 3, 4}, []byte("hello"))
		trie2.Put([]byte{1, 2}, []byte("world"))

		require.Equal(t, trie1.Hash(), trie2.Hash())
	})
}
}--!></code></pre></div><h3>Verify the inclusion of a key-value pair</h3><p>Yes, the trie can verify data integrity, but why not simply comparing the hash by hashing the entire list of key-value pairs, why bother creating a trie data structure?</p><p>That’s because trie also allows us to verify the inclusion of a key-value pair without the access to the entire key-value pairs.</p><p>That means trie can provide a proof to prove that a certain key-value pair is included in a key-value mapping that produces a certain merkle root hash.</p><div class="w-embed"><pre><code class="language-markup"><!--
type Proof interface {}

type Trie interface {
  // generate a merkle proof for a key-value pair for verifying the inclusion of the key-value pair
  Prove(key []byte) (Proof, bool)
}

// verify the proof for the given key with the given merkle root hash
func VerifyProof(rootHash []byte, key []byte, proof Proof) (value []byte, err error)
}--!></code></pre></div><p>This is useful in Ethereum. For instance, imagine the Ethereum world state is a key-value mapping, and the keys are each account address, and the values are the balances for each account.</p><p>As a light client, which don’t have the access to the full blockchain state like full nodes do, but only the merkle root hash for certain block, how can it trust the result of its account balance returned from a full node?</p><p>The answer is, a full node can provide a merkle proof which contains the merkle root hash, the account key and its balance value, as well as other data. This merkle proof allows a light client to verify the correctness by its own without having access to the full blockchain state.</p><p>Let’s explain this behavior with test cases:</p><div class="w-embed"><pre><code class="language-markup"><!--
func TestProveAndVerifyProof(t *testing.T) {
	t.Run("should not generate proof for non-exist key", func(t *testing.T) {
		tr := NewTrie()
		tr.Put([]byte{1, 2, 3}, []byte("hello"))
		tr.Put([]byte{1, 2, 3, 4, 5}, []byte("world"))
		notExistKey := []byte{1, 2, 3, 4}
		_, ok := tr.Prove(notExistKey)
		require.False(t, ok)
	})

	t.Run("should generate a proof for an existing key, the proof can be verified with the merkle root hash", func(t *testing.T) {
		tr := NewTrie()
		tr.Put([]byte{1, 2, 3}, []byte("hello"))
		tr.Put([]byte{1, 2, 3, 4, 5}, []byte("world"))

		key := []byte{1, 2, 3}
		proof, ok := tr.Prove(key)
		require.True(t, ok)

		rootHash := tr.Hash()

		// verify the proof with the root hash, the key in question and its proof
		val, err := VerifyProof(rootHash, key, proof)
		require.NoError(t, err)

		// when the verification has passed, it should return the correct value for the key
		require.Equal(t, []byte("hello"), val)
	})

	t.Run("should fail the verification if the trie was updated", func(t *testing.T) {
		tr := NewTrie()
		tr.Put([]byte{1, 2, 3}, []byte("hello"))
		tr.Put([]byte{1, 2, 3, 4, 5}, []byte("world"))

		// the hash was taken before the trie was updated
		rootHash := tr.Hash()

		// the proof was generated after the trie was updated
		tr.Put([]byte{5, 6, 7}, []byte("trie"))
		key := []byte{1, 2, 3}
		proof, ok := tr.Prove(key)
		require.True(t, ok)

		// should fail the verification since the merkle root hash doesn't match
		_, err := VerifyProof(rootHash, key, proof)
		require.Error(t, err)
	})
}
}--!></code></pre></div><p>A light client can ask for a merkle root hash of the trie state, and use it to verify the balance of its account. If the trie was updated, even if the updates was to other keys, then the verification would fail.</p><p>And now, the light client only needs to trust the merkle root hash, which is a small piece of data, to convince themselves whether the full node returned the correct balance for its account.</p><p>OK, but why should the light client trust the merkle root hash?</p><p>Since Ethereum’s consensus mechanism is Proof of Work, and the merkle root hash for the world state is included in each block head, the computation work is the proof for verifying/trusting the merkle root hash.</p><p>It’s pretty cool that small as the merkle root hash can be used to verify the state of a giant key-value mapping.</p><h3>Verify the implementation</h3><p>I’ve explained how merkle patricia trie works. <a href="https://github.com/zhangchiqing/merkle-patricia-trie" target="_blank">This repo</a> provides a simple implementation. But, how can we verify our implementation?</p><p>An easy way is to verify with the Ethereum mainnet data and the official Trie golang implementation.</p><p>Ethereum has 3 Merkle Patricia Tries: Transaction Trie, Receipt Trie and State Trie. In each block header, it includes the 3 merkle root hashes: transactionRoot, receiptRoot and the stateRoot.</p><p>Since the transactionRoot is the merkle root hash of all the transactions included in the block, we could verify our implementation by taking all the transactions, then store them in our trie, compute its merkle root hash, and in the end compare it with the transactionRoot in the block header.</p><p>For instance, I picked the <a href="https://etherscan.io/block/10467135" target="_blank">block 10467135 on mainnet</a>, and saved all the 193 transactions into a <a href="https://github.com/zhangchiqing/merkle-patricia-trie/blob/master/transactions.json" target="_blank">transactions.json</a> file.</p><p>Since the transaction root for block 10467135 is <a href="https://api.etherscan.io/api?module=proxy&amp;action=eth_getBlockByNumber&amp;tag=0x9fb73f&amp;boolean=true&amp;apikey=YourApiKeyToken" target="_blank">0xbb345e208bda953c908027a45aa443d6cab6b8d2fd64e83ec52f1008ddeafa58</a>. I can create a test case that adds the 193 transactions of block 10467135 to our Trie and check:</p><ul role="list"><li>Whether the merkle root hash is bb345e208bda953c908027a45aa443d6cab6b8d2fd64e83ec52f1008ddeafa58.</li><li>Whether a merkle proof for a certain transaction generated from our trie implementation could be verified by the official implementation.</li></ul><p>But what would be the keys and values for the list of transactions? The keys are the RLP encoding of a unsigned integer starting from index 0; the values are the RLP encoding of the corresponding transactions.</p><p>OK, let’s see the test cases:</p><div class="w-embed"><pre><code class="language-markup"><!--
import (
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/trie"
)
// use the official golang implementation to check if a valid proof from our implementation can be accepted
func VerifyProof(rootHash []byte, key []byte, proof Proof) (value []byte, err error) {
	return trie.VerifyProof(common.BytesToHash(rootHash), key, proof)
}
// load transaction from json
func TransactionJSON(t *testing.T) *types.Transaction {
	jsonFile, err := os.Open("transaction.json")
	defer jsonFile.Close()
	require.NoError(t, err)
	byteValue, err := ioutil.ReadAll(jsonFile)
	require.NoError(t, err)
	var tx types.Transaction
	json.Unmarshal(byteValue, &tx)
	return &tx
}
func TestTransactionRootAndProof(t *testing.T) {
	trie := NewTrie()
	txs := TransactionsJSON(t)
	for i, tx := range txs {
		// key is the encoding of the index as the unsigned integer type
		key, err := rlp.EncodeToBytes(uint(i))
		require.NoError(t, err)
		transaction := FromEthTransaction(tx)
		// value is the RLP encoding of a transaction
		rlp, err := transaction.GetRLP()
		require.NoError(t, err)
		trie.Put(key, rlp)
	}
	// the transaction root for block 10467135
	// https://api.etherscan.io/api?module=proxy&action=eth_getBlockByNumber&tag=0x9fb73f&boolean=true&apikey=YourApiKeyToken
	transactionRoot, err := hex.DecodeString("bb345e208bda953c908027a45aa443d6cab6b8d2fd64e83ec52f1008ddeafa58")
	require.NoError(t, err)
	t.Run("merkle root hash should match with 10467135's transactionRoot", func(t *testing.T) {
		// transaction root should match with block 10467135's transactionRoot
		require.Equal(t, transactionRoot, trie.Hash())
	})
	t.Run("a merkle proof for a certain transaction can be verified by the offical trie implementation", func(t *testing.T) {
		key, err := rlp.EncodeToBytes(uint(30))
		require.NoError(t, err)
		proof, found := trie.Prove(key)
		require.Equal(t, true, found)
		txRLP, err := VerifyProof(transactionRoot, key, proof)
		require.NoError(t, err)
		// verify that if the verification passes, it returns the RLP encoded transaction
		rlp, err := FromEthTransaction(txs[30]).GetRLP()
		require.NoError(t, err)
		require.Equal(t, rlp, txRLP)
	})
}
}--!></code></pre></div><p>The above test cases passed, and showed if we add all the 193 transactions of block 10467135 to our trie, then the trie hash is the same as the transactionRoot published in that block. And the merkle proof for the transaction with index 30, generated by our trie, is considered valid by official golang trie implementation.</p><h3>Merkle Patricia Trie Internal — Trie Nodes</h3><p>Now, let’s take a look at the internal of the trie.</p><p>Internally, the trie has 4 types of nodes: EmptyNode, LeafNode, BranchNode and ExtensionNode. Each node will be encoded and stored as key-value pairs in the a key-value store.</p><p>As an example, let’s take a look at Block <a href="https://etherscan.io/block/10593417" target="_blank">10593417</a> on mainnet to show how a transaction trie was built and how is it stored.</p><p><a href="https://etherscan.io/block/10593417" target="_blank">Block 10593417</a> only has 4 transactions with the transactionRoot hash: <a href="https://api.etherscan.io/api?module=proxy&amp;action=eth_getBlockByNumber&amp;tag=0xa1a489&amp;boolean=true&amp;apikey=YourApiKeyToken" target="_blank">0xab41f886be23cd786d8a69a72b0f988ea72e0b2e03970d0798f5e03763a442cc</a>. So to store the 4 transactions to a trie, we are actually storing the following key-value pairs in hex-string form:</p><div class="w-embed"><pre><code class="language-markup"><!--
(80, f8ab81a5852e90edd00083012bc294a3bed4e1c75d00fa6f4e5e6922db7261b5e9acd280b844a9059cbb0000000000000000000000008bda8b9823b8490e8cf220dc7b91d97da1c54e250000000000000000000000000000000000000000000000056bc75e2d6310000026a06c89b57113cf7da8aed7911310e03d49be5e40de0bd73af4c9c54726c478691ba056223f039fab98d47c71f84190cf285ce8fc7d9181d6769387e5efd0a970e2e9)
(01, f8ab81a6852e90edd00083012bc294a3bed4e1c75d00fa6f4e5e6922db7261b5e9acd280b844a9059cbb0000000000000000000000008bda8b9823b8490e8cf220dc7b91d97da1c54e250000000000000000000000000000000000000000000000056bc75e2d6310000026a0d77c66153a661ecc986611dffda129e14528435ed3fd244c3afb0d434e9fd1c1a05ab202908bf6cbc9f57c595e6ef3229bce80a15cdf67487873e57cc7f5ad7c8a)
(02, f86d8229f185199c82cc008252089488e9a2d38e66057e18545ce03b3ae9ce4fc360538702ce7de1537c008025a096e7a1d9683b205f697b4073a3e2f0d0ad42e708f03e899c61ed6a894a7f916aa05da238fbb96d41a4b5ec0338c86cfcb627d0aa8e556f21528e62f31c32f7e672)
(03, f86f826b2585199c82cc0083015f9094e955ede0a3dbf651e2891356ecd0509c1edb8d9c8801051fdc4efdc0008025a02190f26e70a82d7f66354a13cda79b6af1aa808db768a787aeb348d425d7d0b3a06a82bd0518bc9b69dc551e20d772a1b06222edfc5d39b6973e4f4dc46ed8b196)
}--!></code></pre></div><p>80 is the hex form of the bytes from the result of RLP encoding of unsigned integer 0: RLP(uint(0)). 01 is the result of RLP(uint(1)), and so on.</p><p>The value for key 80 is the result of RLP encoding of the first transaction. The value for key 01 is for the second transaction, and so on.</p><p>So we will add the above 4 key-value pairs to the trie, and let’s see how the internal structure of the trie changes when adding each of them.</p><p>To be more intuitive, I will use some diagrams to explain how it works. You could also inspect the state of each step by adding logs to the test cases.</p><h3>Empty Trie</h3><p>The trie structure contains only a root field pointing to a root node. And the Node type is an interface, which could be one of the 4 types of nodes.</p><div class="w-embed"><pre><code class="language-markup"><!--
type Trie struct {
	root Node
}
}--!></code></pre></div><p>When a trie is created, the root node points to an EmptyNode.</p><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315c95c9c1068bfd255b_0*BYqeU9FQ8XycgGzn.png"/></div></figure><h3>Adding the 1st transaction</h3><p>When adding the key-value pair of the 1st transaction, a LeafNode is created with the transaction data stored in it. And the root node is updated to point to that LeafNode.</p><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315c7fb89d059397bde1_0*_Db4DXKBpizQy8MK.png"/></div></figure><h3>Adding the 2nd transaction</h3><p>When adding the 2nd transaction, the LeafNode at the root will be turned into a BranchNode with two branches pointing to the 2 LeafNodes. The LeafNode on the right side holds the remaining nibbles (nibbles are a single hex character) — 1, and the value for the 2nd transaction.</p><p>And now the root node is pointing to the new BranchNode.</p><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315c94fd2b0c34cde5ae_0*uzhir0og2SZViZro.png"/></div></figure><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315c5feb8a8390684162_0*unWqowgtI-GkI8lE.png"/></div></figure><h3>Adding the 3rd transaction</h3><p>Adding the 3rd transaction will turn the LeafNode on the left side to be a BranchNode, similar to the process of adding the 2nd transaction. Although the root node didn’t change, its root hash has been changed, because it’s 0 branch is pointing to a different node with different hashes.</p><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315c95c9c14281fd257b_0*QmqsSV21X4yWBdRf.png"/></div></figure><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315c9c2bc753d57e33e1_0*lKYjTtEBejSk_cdj.png"/></div></figure><h3>Adding the 4th transaction</h3><p>Adding the last transaction is similar to adding the 3rd transaction. Now we can verify the root hash is identical to the transactionRoot included in the block.</p><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315c171a4b410018e096_0*qyibUzFgNbM0xeuO.png"/></div></figure><figure class="w-richtext-figure-type- "><div><img alt="" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b315d397f0701da555e54_0*8vDha0wk4duXGWud.png"/></div></figure><h3>Getting Merkle Proof for the 3rd transaction</h3><p>The Merkle Proof for the 3rd transaction is simply the path to the LeafNode that stores the value of the 3rd transaction. When verifying the proof, one can start from the root hash, decode the Node, match the nibbles, and repeat until find the Node that matches all the remaining nibbles. If found, then the value is the one paired with the key; if not found, then the merkle proof is invalid.</p><h3>The rule of updating the trie</h3><p>In the above example, we’ve built a trie with 3 types of Nodes: EmptyNode, LeafNode and BranchNode. However, we didn’t have the chance to use ExtensionNode. Please find other test cases that use the ExtensionNode.</p><p>In general, the rule is:</p><ul role="list"><li>When stopped at an EmptyNode, replace it with a new LeafNode with the remaining path.</li><li>When stopped at a LeafNode, convert it to an ExtensionNode and add a new branch and a new LeafNode.</li><li>When stopped at an ExtensionNode, convert it to another ExtensionNode with shorter path and create a new BranchNode points to the ExtensionNode.</li></ul><p>There are quite some details, if you are interested, you can read the <a href="https://github.com/zhangchiqing/merkle-patricia-trie/blob/master/trie.go#L62" target="_blank">source code</a>.</p><h3>Summary</h3><p>Merkle Patricia Trie is a data structure that stores key-value pairs, just like a map. In additional to that, it also allows us to verify data integrity and the inclusion of a key-value pair.</p><h3>More</h3><p>Merkle Trie is heavily used in Ethereum storage, if you are interested in learning more, check out my blog post series:</p><ul role="list"><li><a href="https://medium.com/@chiqing/merkle-patricia-trie-explained-ae3ac6a7e123"><em>Merkle Patricia Trie Explained</em></a></li><li><a href="https://medium.com/@chiqing/verify-ethereum-account-balance-with-state-proof-83b51ceb15cf"><em>Verify Ethereum Account Balance with State Proof</em></a></li><li><a href="https://medium.com/@chiqing/eip-1186-explained-the-standard-for-getting-account-proof-444bc1e12e03"><em>EIP 1186 — the standard for getting account proof</em></a></li><li><a href="https://medium.com/@chiqing/verify-ethereum-smart-contract-state-with-proof-1a8a0b4c8008"><em>Verify Ethereum Smart Contract State with Proof</em></a></li><li><a href="https://medium.com/@chiqing/verify-usdc-balance-and-nft-meta-data-with-proof-3b4d065ae923"><em>Verify USDC Balance and NFT Meta Data with Proof</em></a></li></ul></div><div class="tags-post-div"><div class="tags-title-14">Tags:</div><div class="w-dyn-list"><div role="list" class="tag-cloud w-dyn-items"><div role="listitem" class="w-dyn-item"><div class="tags-title">Merkle Patricia Trie</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Blockchain</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Merkle Tree</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Web 3</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Ethereum</div></div></div></div></div></div></div></div></div></div><div class="post-with-text-layout hide"><div class="blog-post-hero-2 no-image wf-section"><div class="post-container w-container"><div><div class="blog-post-meta-data in-post"><div class="blog-post-category">Studio</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">03/30/2021</div></div><div class="main-blog-post-title">Welcoming Animoca, MotoGP, and StarGirl to Flow</div><div class="blog-post-meta-data post"><div class="blog-post-meta-text-data dark">Mik Naayem</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">CBO and Cofounder at Dapper Labs</div></div></div></div></div><div class="blog-post-section wf-section"><div class="container-25 _1280 w-container"><div class="post-info-parent no-img"><div class="post-share-sidebar"><div class="social-share-btn-2 tw"></div><div class="social-share-btn-2 email"></div><div class="share-text">Share</div></div><div class="post-main-info-div"><div class="blog-post-rich-text w-richtext"><p>The rich text element allows you to create and format headings, paragraphs, blockquotes, images, and video all in one place instead of having to add and format them individually. Just double-click and easily create content.</p><ul role="list"><li>Decentralized because you can set up a blockchain system so that every entity can only make changes within its predefined purview. Companies can also use permissionless, permissioned, or hybrid-approach blockchains, allowing for useful trade-offs between network security and system privacy.</li><li>Decentralized because you can set up a blockchain system so that every entity can only make changes within its predefined purview. Companies can also use permissionless, permissioned, or hybrid-approach blockchains, allowing for useful trade-offs between network security and system privacy.</li><li>scscsssc</li></ul><h4>Static and dynamic content editing</h4><blockquote>A rich text element can be used with static or dynamic content. For static content, just drop it into any page and begin editing. For dynamic content, add a<a href="http://www.google.com"> rich text field to any collection</a> and then connect a rich text element to that field in the settings panel. Voila!</blockquote><h4>How to customize formatting for each rich text</h4><p>Headings, paragraphs, blockquotes, figures, images, and figure captions can all be styled after a class is added to the rich text element using the &quot;When inside of&quot; nested selector system.</p></div></div></div></div></div></div><div class="section-32 wf-section"><div class="container-25 _1280 w-container"><div class="title-div-3"><div>Related Content</div></div><div class="w-dyn-list"><div role="list" class="w-dyn-items"><div role="listitem" class="w-dyn-item"><div class="blog-post-parant-div first"><div class="blog-post-info-div"><a href="/engineering-blogs/upgrading-flows-consensus-follower-to-boost-attack-resilience-and-processing-speed" class="blog-post-title">Upgrading Flow&#x27;s Consensus Follower to boost attack resilience and processing speed</a><div class="blog-post-meta-data"><div class="blog-post-meta-text-data">May 30, 2023</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Jordan Schalm</div></div></div></div></div><div role="listitem" class="w-dyn-item"><div class="blog-post-parant-div first"><div class="blog-post-info-div"><a href="/engineering-blogs/jolteon-advancing-flows-consensus-algorithm" class="blog-post-title">Jolteon: Advancing Flow’s consensus algorithm</a><div class="blog-post-meta-data"><div class="blog-post-meta-text-data">Apr 14, 2023</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Jordan Schalm</div></div></div></div></div><div role="listitem" class="w-dyn-item"><div class="blog-post-parant-div first"><div class="blog-post-info-div"><a href="/engineering-blogs/golang-services-improving-observability" class="blog-post-title">Improving Observability of GoLang Services</a><div class="blog-post-meta-data"><div class="blog-post-meta-text-data">Jan 31, 2023</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Alexey Ivanov</div></div></div></div></div></div></div></div></div></div><div class="section footer wf-section"><div class="footer-div"><div class="join-text-2 no-hover">Join Flow on</div><a href="https://twitter.com/flow_blockchain" target="_blank" class="join-text-2">Twitter</a><a href="https://discord.com/invite/J6fFnh2xx6" target="_blank" class="join-text-2">Discord</a><a href="https://flow.com/" target="_blank" class="join-text-2">flow.com</a></div></div><div class="new-footer wf-section"><div class="container w-container"><div class="w-layout-grid _3-footer-grid"><div><a id="w-node-ec243fb8-8059-5bdb-528d-ce0b082ca18b-082ca187" href="/" class="footer-logo-link w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63ce603ae36f46f6bb67e51e_flow-logo.svg" loading="lazy" alt="flow logo" class="footer-logo-img"/></a><div class="footer-social-icons"><a href="https://twitter.com/flow_blockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec770abbeba426e358f76_Twitter%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://www.instagram.com/flowblockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec770799e2958d15306a0_Instagram%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://www.youtube.com/@FlowBlockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec77005a49eaba248e147_YouTube%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://t.me/flow_blockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec770b75d5482a08014db_Telegram%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://discord.com/invite/J6fFnh2xx6" target="_blank" class="footer-social-icon last w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63d0398494fe5d96e72f4cc0_Social%20Icon.svg" loading="lazy" alt="social icon"/></a></div></div><div id="w-node-_843ebe60-d3a2-032c-780e-737a5989cba0-082ca187"><div class="footer-column-header">Start Building</div><a href="https://developers.flow.com/" target="_blank" class="new-footer-link">Developer portal</a><a href="https://github.com/onflow" target="_blank" class="new-footer-link">GitHub</a></div><div id="w-node-ec243fb8-8059-5bdb-528d-ce0b082ca19f-082ca187"><div class="footer-column-header">Flow</div><a href="https://docs.google.com/forms/d/e/1FAIpQLSer5ZX0pRWsXF0U0bsgW4Zo8Pmlw0V927ZydDq_ej-qyIJ9_A/viewform" target="_blank" class="new-footer-link">Business Development</a><a href="https://flow.com/node-operation" target="_blank" class="new-footer-link">Node Operation</a><a href="/token-distribution" class="new-footer-link">Token Distribution</a><a href="/mediakit" class="new-footer-link">Media Kit</a><a href="/careers" class="new-footer-link">Careers</a><a href="/faq" class="new-footer-link">FAQ</a></div><div id="w-node-ec243fb8-8059-5bdb-528d-ce0b082ca198-082ca187"><div class="footer-column-header">Get Connected</div><a href="https://port.onflow.org/" target="_blank" class="new-footer-link">Flow Port</a><a href="https://www.flowverse.co/" target="_blank" class="new-footer-link">Flowverse</a></div></div><div class="div-block-129"><div class="footer-copyright">© 2023 All Rights Reserved</div></div></div></div><script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=5f734f4dbd95382f4fdfa0ea" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/js/webflow.2724f1538.js" type="text/javascript"></script><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NHJB3BPPXG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NHJB3BPPXG');
</script>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PWSGFLB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --><script src="../../cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="../../cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/unescaped-markup/prism-unescaped-markup.min.js"></script></body>
<!-- Mirrored from flow.com/engineering-blogs/ethereum-merkle-patricia-trie-explained by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Jul 2023 16:25:06 GMT -->
</html>