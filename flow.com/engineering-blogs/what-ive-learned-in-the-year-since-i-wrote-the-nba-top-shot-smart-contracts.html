<!DOCTYPE html><!-- This site was created in Webflow. https://www.webflow.com --><!-- Last Published: Mon Jul 17 2023 22:17:53 GMT+0000 (Coordinated Universal Time) --><html data-wf-domain="flow-com.webflow.io" data-wf-page="637380c394c328ab5ad74bb3" data-wf-site="5f734f4dbd95382f4fdfa0ea" lang="en">
<!-- Mirrored from flow.com/engineering-blogs/what-ive-learned-in-the-year-since-i-wrote-the-nba-top-shot-smart-contracts by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Jul 2023 16:27:24 GMT -->
<head><meta charset="utf-8"/><title>What I‚Äôve learned in the year since I wrote the NBA Top Shot smart contracts</title><meta content="Mar 12, 2021" name="description"/><meta content="What I‚Äôve learned in the year since I wrote the NBA Top Shot smart contracts" property="og:title"/><meta content="Mar 12, 2021" property="og:description"/><meta content="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b136cf2e7e1731c1769d2_1_su7ETuFRNALht2b_nJu-ZA.webp" property="og:image"/><meta content="What I‚Äôve learned in the year since I wrote the NBA Top Shot smart contracts" property="twitter:title"/><meta content="Mar 12, 2021" property="twitter:description"/><meta content="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b136cf2e7e1731c1769d2_1_su7ETuFRNALht2b_nJu-ZA.webp" property="twitter:image"/><meta property="og:type" content="website"/><meta content="summary_large_image" name="twitter:card"/><meta content="width=device-width, initial-scale=1" name="viewport"/><meta content="goOrjM0FiQtmK2lUJ9Y5NpPJA-fMUUc_6Q6Vmd7-XIY" name="google-site-verification"/><meta content="Webflow" name="generator"/><link href="../../assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/css/flow-com.webflow.9325b97a3.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/" rel="preconnect"/><link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="anonymous"/><script src="../../ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script><script type="text/javascript">WebFont.load({  google: {    families: ["Epilogue:300,regular,500,600,700,800,900,italic"]  }});</script><script src="../../use.typekit.net/mgu2ukv.js" type="text/javascript"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="../../assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/616b1520779838b5f9174363_favicon.png" rel="shortcut icon" type="image/x-icon"/><link href="../../assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/616b1548fd01d005fc2bc2c7_logo256.png" rel="apple-touch-icon"/><link href="what-ive-learned-in-the-year-since-i-wrote-the-nba-top-shot-smart-contracts.html" rel="canonical"/><style>
  .w-webflow-badge {
    display: none !important;
  }
</style>


<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'../../www.googletagmanager.com/gtm5445.html?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PWSGFLB');</script>
<!-- End Google Tag Manager -->


<meta name="facebook-domain-verification" content="dhlb5fcuitl7owilmsg6xh307ohoyc" />

<!-- Hotjar Tracking Code for Flow.com -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:3329982,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>
<link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" /></head><body><div data-animation="default" data-collapse="medium" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navigation w-nav"><div class="nav-container w-container"><a href="../index.html" class="nav-logo-div w-nav-brand"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63ce603ae36f46f6bb67e51e_flow-logo.svg" loading="lazy" alt="flow logo" class="hide"/><div aria-label="Flow logo" class="nav-logo__embed w-embed"><svg width="100" height="42" viewBox="0 0 100 42" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_106_24812)">
<path class="logotype" d="M57.3672 20.9501H54.6797V30.971H50.9297V20.9501H48.9922V17.7376H50.9297V16.4876C50.9297 13.2501 52.9505 11.5876 56.0214 11.5876C56.4968 11.5916 56.9705 11.6475 57.4339 11.7543V15.5043C57.0296 15.3422 56.5985 15.2574 56.163 15.2543C55.9663 15.2387 55.7684 15.2659 55.5832 15.334C55.3979 15.4021 55.2296 15.5096 55.0899 15.6489C54.9501 15.7883 54.8422 15.9563 54.7735 16.1414C54.7049 16.3264 54.6771 16.5242 54.6922 16.721V17.7168H57.3797L57.3672 20.9501ZM63.013 30.971H59.2214V11.871H63.013V30.971Z" fill="black"/>
<path class="logotype" d="M71.4292 16.9085C72.851 16.906 74.2415 17.3255 75.4247 18.1139C76.6079 18.9023 77.5306 20.024 78.0758 21.3371C78.6211 22.6502 78.7644 24.0956 78.4876 25.4902C78.2108 26.8848 77.5264 28.1658 76.5211 29.1712C75.5157 30.1766 74.2346 30.861 72.84 31.1377C71.4454 31.4145 70.0001 31.2712 68.687 30.726C67.3739 30.1807 66.2521 29.2581 65.4638 28.0749C64.6754 26.8917 64.2559 25.5011 64.2584 24.0793C64.2466 23.1344 64.4241 22.1967 64.7803 21.3213C65.1365 20.446 65.6642 19.6508 66.3325 18.9826C67.0007 18.3144 67.7959 17.7866 68.6712 17.4304C69.5465 17.0742 70.4842 16.8968 71.4292 16.9085V16.9085ZM71.4292 27.596C73.3667 27.596 74.7625 25.9877 74.7625 24.0793C74.7834 23.6288 74.7126 23.1787 74.5544 22.7563C74.3963 22.3339 74.1541 21.9481 73.8424 21.622C73.5308 21.296 73.1562 21.0366 72.7414 20.8595C72.3266 20.6824 71.8802 20.5914 71.4292 20.5918C70.5213 20.6232 69.661 21.0058 69.0298 21.6592C68.3986 22.3125 68.0458 23.1855 68.0458 24.0939C68.0458 25.0024 68.3986 25.8753 69.0298 26.5286C69.661 27.182 70.5213 27.5647 71.4292 27.596Z" fill="black"/>
<path class="logotype" d="M82.5576 17.1875L84.9951 26.3542L87.4326 19.0708L86.7659 17.1917H90.5159L93.7284 26.3583L96.1076 17.1917H99.9992L95.9034 30.975H91.9701L89.2284 23.4167L86.6659 30.9708H82.7076L78.6367 17.1875H82.5576Z" fill="black"/>
<path d="M20.8333 41.8334C32.3393 41.8334 41.6667 32.506 41.6667 21.0001C41.6667 9.49415 32.3393 0.166748 20.8333 0.166748C9.3274 0.166748 0 9.49415 0 21.0001C0 32.506 9.3274 41.8334 20.8333 41.8334Z" fill="#00EF8B"/>
<path d="M29.9732 17.7417H24.0898V23.625H29.9732V17.7417Z" fill="white"/>
<path d="M18.2138 25.8292C18.2138 26.266 18.0843 26.6929 17.8416 27.0561C17.599 27.4192 17.2541 27.7023 16.8506 27.8694C16.447 28.0366 16.003 28.0803 15.5746 27.9951C15.1463 27.9099 14.7528 27.6996 14.4439 27.3907C14.1351 27.0819 13.9248 26.6884 13.8396 26.26C13.7544 25.8316 13.7981 25.3876 13.9652 24.9841C14.1324 24.5806 14.4154 24.2357 14.7786 23.993C15.1417 23.7504 15.5687 23.6209 16.0055 23.6209H18.2138V17.7417H16.0055C14.4059 17.7417 12.8423 18.216 11.5123 19.1047C10.1823 19.9934 9.14572 21.2564 8.5336 22.7342C7.92147 24.212 7.76131 25.8382 8.07337 27.407C8.38543 28.9758 9.15569 30.4169 10.2867 31.5479C11.4178 32.679 12.8589 33.4492 14.4277 33.7613C15.9965 34.0733 17.6226 33.9132 19.1004 33.3011C20.5782 32.6889 21.8413 31.6523 22.73 30.3224C23.6186 28.9924 24.093 27.4287 24.093 25.8292V23.6209H18.2138V25.8292Z" fill="white"/>
<path d="M26.2984 14.8001H32.9151V8.91675H26.2984C24.1542 8.91895 22.0984 9.77174 20.5821 11.288C19.0659 12.8042 18.2131 14.86 18.2109 17.0042V17.7417H24.0901V17.0042C24.0912 16.4193 24.3244 15.8587 24.7384 15.4454C25.1524 15.0322 25.7135 14.8001 26.2984 14.8001V14.8001Z" fill="white"/>
<path d="M18.2109 23.6209H24.0901V17.7417H18.2109V23.6209Z" fill="#00EF8B"/>
</g>
<defs>
<clipPath id="clip0_106_24812">
<rect width="100" height="41.6666" fill="white" transform="translate(0 0.166748)"/>
</clipPath>
</defs>
</svg></div></a><nav role="navigation" class="new-navigation-menu w-nav-menu"><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Solutions</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list w-dropdown-list"><a href="../hybrid-custody.html" class="navigation-dropdown-link w-dropdown-link">Walletless Onboarding +Hybrid Custody</a><a href="http://developers.flow.com/hybrid-custody/guides/account-abstraction" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Account Abstraction</a><a href="https://developers.flow.com/cadence" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Cadence</a></nav></div><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Developers</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list w-dropdown-list"><a href="https://developers.flow.com/" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Developer portal</a><a href="https://github.com/onflow" class="navigation-dropdown-link w-dropdown-link">GitHub</a></nav></div><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Ecosystem</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list ecosystem w-dropdown-list"><a href="https://www.flowverse.co/" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Flowverse</a></nav></div><div data-hover="false" data-delay="0" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">Community</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list community w-dropdown-list"><a href="../flow-ambassador-program.html" class="navigation-dropdown-link w-dropdown-link">Ambassador program</a><a href="../blog.html" class="navigation-dropdown-link w-dropdown-link">Blog</a><a href="https://forum.onflow.org/" target="_blank" class="navigation-dropdown-link icon w-dropdown-link">Forum</a><a href="https://discord.com/invite/J6fFnh2xx6" target="_blank" class="navigation-dropdown-link discord w-dropdown-link">Discord</a><a href="https://twitter.com/flow_blockchain" class="navigation-dropdown-link twitter w-dropdown-link">Twitter</a></nav></div><div data-hover="false" data-delay="100" class="w-dropdown"><div class="new-nav-link w-dropdown-toggle"><div class="nav-link-text">About</div><div class="nav-link-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="navigation-dropdown-list ecosystem w-dropdown-list"><a href="../primer.html" class="navigation-dropdown-link w-dropdown-link">Primer</a><a href="../priorities.html" class="navigation-dropdown-link w-dropdown-link">Priorities</a><a href="../use-cases.html" class="navigation-dropdown-link w-dropdown-link">Use Cases</a><a href="../flow-token-economics.html" class="navigation-dropdown-link w-dropdown-link">Token economics</a><a href="../technical-paper.html" class="navigation-dropdown-link w-dropdown-link">Technical papers</a><a href="../sustainability.html" class="navigation-dropdown-link w-dropdown-link">Sustainability</a></nav></div></nav><div class="new-menu-button w-nav-button"><div class="w-icon-nav-menu"></div></div></div></div><div><div class="post-with-image-layout"><div class="blog-post-hero-2 wf-section"><div class="post-container w-container"><div><div class="blog-post-meta-data in-post"><div class="w-dyn-list"><div role="list" class="eng-blog-category-list w-dyn-items"><div role="listitem" class="w-dyn-item"><a href="../engineering-categories/cadence.html" class="radius-text w-inline-block"><div class="eco-text-2">Cadence</div></a></div></div></div><div class="small-dot-sep inpost left"></div><div class="blog-post-meta-text-data">March 12, 2021</div></div><div class="main-blog-post-title">What I‚Äôve learned in the year since I wrote the NBA Top Shot smart contracts</div><div class="blog-post-meta-data post"><a href="../authors/joshua-hannan.html" class="blog-post-meta-text-data dark">Joshua Hannan</a><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Smart Contract Engineer at Dapper Labs</div></div></div></div></div><div class="blog-post-section wf-section"><div class="container-25 _1280 w-container"><div class="post-info-parent"><div class="post-share-sidebar"><div class="social-share-btn-2 tw"></div><div class="social-share-btn-2 email"></div><div class="share-text">Share</div></div><div class="post-main-info-div eng"><img loading="lazy" src="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b136cf2e7e1731c1769d2_1_su7ETuFRNALht2b_nJu-ZA.webp" alt="What I‚Äôve learned in the year since I wrote the NBA Top Shot smart contracts" sizes="(max-width: 479px) 83vw, (max-width: 767px) 92vw, (max-width: 991px) 81vw, 750px" srcset="https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b136cf2e7e1731c1769d2_1_su7ETuFRNALht2b_nJu-ZA-p-500.webp 500w, https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b136cf2e7e1731c1769d2_1_su7ETuFRNALht2b_nJu-ZA-p-800.webp 800w, https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b136cf2e7e1731c1769d2_1_su7ETuFRNALht2b_nJu-ZA-p-1080.webp 1080w, https://assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b136cf2e7e1731c1769d2_1_su7ETuFRNALht2b_nJu-ZA.webp 1280w" class="blog-post-main-image"/><div class="blog-post-rich-text-block w-richtext"><p>Hello! My name is Josh, and I write smart contracts at <a href="http://dapperlabs.com/" target="_blank">Dapper Labs</a> for the <a href="https://www.onflow.org/" target="_blank">Flow blockchain.</a></p><p>If you‚Äôre new here, welcome! This is my bi-weekly blog about Cadence, Flow‚Äôs new state-of-the-art language for smart contracts. I recommend starting out with <a href="https://joshuahannan.medium.com/taking-your-first-steps-with-cadence-19dde86bbd0">my first post about beginner materials</a> before reading this, because I‚Äôll be assuming readers already have a basic understanding of Cadence.</p><h3>NBA Top Shot</h3><p>If you are at all interested in learning about Flow or Cadence, you have probably heard of <a href="https://www.nbatopshot.com/" target="_blank">NBA Top Shot</a>, the officially licensed digital collectible experience from Dapper Labs. Top Shot is a large project with many moving parts, but the record of Moment ownership and value transfer is handled by <a href="https://github.com/dapperlabs/nba-smart-contracts" target="_blank">a few smart contracts</a> on the Flow blockchain, which I was in charge of writing. (with the valuable help of many others on the Flow and Top Shot teams!)</p><h4>NBA Top Shot - Pacers fan, @PaversGonnaPave&#x27;s, profile</h4><p>View all 146 Moments they&#x27;ve collected</p><p>www.nbatopshot.com</p><p>Yes, that is my Top Shot collection and yes, I am also an Indiana Pacers fan. You would probably be able to guess that from some of the comments in the Top Shot smart contract.</p><figure class="w-richtext-figure-type- "><div><img alt="" src="../../assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b13746c647c47b0f3226a_1_LML3N22kDdtfPybRFnSucg.png"/></div><figcaption>You can‚Äôt argue with me. You just can‚Äôt</figcaption></figure><p>I started working for Dapper Labs in September of 2019 and while I had years of experience with Solidity and Ethereum, I was still a complete newcomer to Cadence. I started writing the Top Shot contracts in December and finished the first drafts in January, after which we spent a few months tweaking and testing before launching in June.</p><p>Over a year has passed since I wrote the smart contracts, and my skills as a software developer, and particularly a Cadence developer, have improved significantly. While I am proud of what we built and am extremely confident in the security and reliability of the Top Shot smart contracts, there are many things I would have done differently in hindsight to have more consistent design, readability, and usability, kind of like some NBA teams feel about their Jersey choices.</p><figure class="w-richtext-figure-type- "><div><img alt="" src="../../assets-global.website-files.com/618c953e65cc2ba3f44d1a02/639b13743749e734ab7c6dfc_1_At8uQfmwSe9rj-ZsmXqx-Q.png"/></div><figcaption>I will never resist an opportunity to dunk on the 76ers</figcaption></figure><p>In contrast to certain teams‚Äô jersey choices, NBA Top Shot has been very successful to say the least, which has inspired many new teams in the space to want to build similar experiences on Flow. Many of these projects simply copy and paste the Top Shot smart contract code and just change some names without putting much thought into it.</p><p>I totally understand the urge to do this because it requires the least amount of effort on the part of the smart contract developer, but I hope that more newcomers can learn from the decisions of projects that have come before them so they can make meaningful improvements to the state of the art and not be stuck with a sub-optimal way of doing things.</p><p>Lets look at TopShot.cdc</p><h3>The Core Top Shot Contract</h3><p>I would recommend checking out the Top Shot smart contract repo if you haven‚Äôt already.</p><h4>dapperlabs/nba-smart-contracts</h4><p>This repository contains the smart contracts and transactions that implement the core functionality of NBA Top Shot‚Ä¶</p><p>github.com</p><p>‚Äç</p><p>There is a lot of documentation for the contracts there to help you get comfortable, but I‚Äôll give a brief overview here.</p><p>TopShot.cdc is a NFT contract (<a href="https://github.com/onflow/flow-nft" target="_blank">implements the NonFungibleToken interface</a>) that defines the categorization, creation, and ownership of Top Shot Moment NFTs.</p><p>Each Top Shot Moment NFT represents a play from a game in the NBA season. Plays are grouped into sets which usually have some overarching theme, like rarity or the type of the play.</p><p>A set can have one or more plays in it and the same play can exist in multiple sets, but the combination of a play and a set, otherwise known as an edition, is unique and is what classifies an individual Moment.</p><p>Multiple Moments can be minted from the same edition and each receives a serial number that indicates where in the edition it was minted.</p><p>Funny anecdote: Top Shot used to have a completely different architecture where we had NFT Molds that minted new moments, but that is a story for another day. Good times.</p><p>As you can see, the main structure is fairly simple. You add plays to sets, then mint moments from those combinations. It works well for us and for the users, but there are three main improvements I would like to have made to it and that I think others who are making similar experiences should consider.</p><p>These suggestions apply to <a href="https://github.com/dapperlabs/nba-smart-contracts/tree/31697fb7ed42b0a15b9e8cb11fa1b8b6f78d3c20/contracts" target="_blank">the original version of the Top Shot contracts.</a> Some of the improvements have already been implemented by the Top Shot team and included<a href="https://github.com/dapperlabs/nba-smart-contracts/pull/125" target="_blank"> in an upgrade</a>, but some of them are not able be upgraded using the traditional methods, so they still remain. (the ones that remain aren‚Äôt vulnerabilities, just non-ideal designs) I‚Äôll include a <strong>FIXED </strong>flag for each one that has been fixed in the update.</p><h3>First Improvement: Make Dictionary and Array Fields Private</h3><p><strong>FIXED</strong></p><p>This is a mistake that I see Cadence developers make all the time. In Cadence, fields that are public mean that they are publicly readable but not publicly writable. This only applies to the field itself, but if the field is a dictionary or array, the members of that dictionary or array are still able to be assigned to. See our best practices document for more info:</p><h4>Cadence Anti-Patterns</h4><p>This is an opinionated list of issues that can be improved if they are found in Cadence code intended for production. A‚Ä¶</p><p>docs.onflow.org</p><p>‚Äç</p><p>Any Cadence developer should default to making all dictionary and array fields private by default, by which I mean access(contract) or access(self) . They should also define explicit getter and setter functions for those that make it extremely clear what type of access the developer wants to allow.</p><p>In the case of the Top Shot contract, this means that these fields should be made access(contract):</p><div class="w-embed"><pre><code class="language-markup"><!--
// SHOULD ALL BE `access(contract)`
pub var plays: [UInt32]
pub var retired: {UInt32: Bool}
pub var numberMintedPerPlay: {UInt32: UInt32}
}--!></code></pre></div><p>If they are public, this means that the admin would have the ability to modify the retired status or number minted for specific moment plays, which is not an ability that the admin should have. The Top Shot team is fixing these issues in our contract promptly.</p><h3>Second Improvement: More thoughtful metadata</h3><p>The Play struct currently has two fields:</p><div class="w-embed"><pre><code class="language-markup"><!--
pub let playID: UInt32
pub let metadata: {String: String}
}--!></code></pre></div><p>Metadata for Top Shot NFTs is currently simply a String to String mapping, so for example, a mapping in the metadata field might be &quot;FullName&quot;: &quot;Domantas Sabonis&quot;, or &quot;Golden State Warriors&quot;: ‚ÄúBlew a 3‚Äì1 lead in the 2016 NBA Finals&quot;.</p><p>Each Moment has a bunch of fields. This is a decent way to manage it, but it doesn‚Äôt allow for much wiggle room. If we ever want to add more complex metadata to Top Shot moments, working with this construct will be difficult.</p><p>If I had to redo this, I would have thought more deeply about what potential metadata my project might need to store. It could be a json data structure, an image, or many other things. Every project needs to think deeply about what makes their metadata unique and figure out a way to include it in the smart contract code.</p><p>See <a href="https://github.com/onflow/flow-nft/issues/9#issuecomment-791986853" target="_blank">this issue in the NFT standard repo</a> for a discussion about on-chain metadata if you‚Äôd like to contribute!</p><h3>Third Improvement: Unified Set resource and Set metadata struct</h3><p><strong>Partially Fixed: We added a unified set metadata struct, but could not unify the set resource</strong></p><p>Currently, Sets in Top Shot are represented by two different data structures:</p><ul role="list"><li>A SetData struct, which records the id, name, and series of the set.</li><li>A Set resource, which records other information about the set, including plays that are in it, editions, and retired statuses. It also acts as a authorization resource for the admin to create editions, mint moments, retire plays, and more.</li></ul><p>We originally thought it might be useful to have them separate to keep static metadata about a set separate from the dynamic data that the admin controls, but in practice, this isn‚Äôt really that useful and just makes the code a little bit harder to understand and harder to query.</p><p><strong>How could we have improved it?</strong></p><p>If I could do it over again, I would have put all the SetData fields in the Set resource like this:</p><div class="w-embed"><pre><code class="language-markup"><!--
pub resource Set {
  pub let setID: UInt32
  pub let name: String
  pub let series: UInt32
  pub var plays: [UInt32]
  pub var retired: {UInt32: Bool}
  pub var locked: Bool
  pub var numberMintedPerPlay: {UInt32: UInt32}
  ...
}
}--!></code></pre></div><p>This way, we have a single unified Set object that the admin uses to manage set data. Then, I would have also removed the setDatas field from the smart contract, because those are stored in the Set resource now, so the field isn‚Äôt necessary.</p><div class="w-embed"><pre><code class="language-markup"><!--
access(self) var setDatas: {UInt32: SetData} // REMOVE
}--!></code></pre></div><p>I also would change theSetData struct definition to have all of the same fields as the Set resource. You might be wondering, ‚ÄúIf you removed the SetData field, why does the SetData struct still need to exist?‚Äù</p><div class="w-embed"><pre><code class="language-markup"><!--
// New SetData struct with all the same fields as Set
//
pub struct SetData {
  pub let setID: UInt32
  pub let name: String
  pub let series: UInt32
  pub var plays: [UInt32]
  pub var retired: {UInt32: Bool}
  pub var locked: Bool
  pub var numberMintedPerPlay: {UInt32: UInt32}
  init(setID: UInt32) {
    self.setID = TopShot.setDatas[setID].setID
    self.name = TopShot.setDatas[setID].name
    //... and so on
}
}--!></code></pre></div><p>In the original version of the Top Shot contract, when someone wants to query information about a Set or Play in Top Shot, they have to call individual getter functions for each piece of data. This is very cumbersome and I have discovered in my time since writing the contract that it is almost always better to group related data together for queries.</p><p>Since SetData no longer needs to be the source of truth for important Set metadata, it can be used for a better purpose, an easily queryable source of all the current information about a Set. Now, if someone wants a piece or all of the information about a Set, they can simply find all the information in one place by instantiating a new SetData struct for the set they want to know about, like this!</p><div class="w-embed"><pre><code class="language-markup"><!--
pub fun main(id: UInt32): SetData {
  let set = TopShot.SetData(setID: id)
  log(set.name)
  log(set.locked)
  ...
  return set
}
}--!></code></pre></div><p>They could parse it however they want within the script, or within the application code that sent the script. It gives the developer a lot more flexibility than the sufficient, but restrictive getters that the Top Shot contract currently provides.</p><h3>Fourth Improvement: Perform state changing operations in admin resources, not in public structs</h3><p><strong>FIXED</strong></p><p>In the original version of the Top Shot contract, when a new play or set is created, the ID tracker for the play or the set would be incremented to make sure that the next play or set created would have a unique ID. It would also emit an event indicating what the new play or set is. Seems fine on the surface, but the problem arises from where these operations happen.</p><p>These operations were performed <a href="https://github.com/dapperlabs/nba-smart-contracts/blob/31697fb7ed42b0a15b9e8cb11fa1b8b6f78d3c20/contracts/TopShot.cdc#L148-L159" target="_blank">in the initializer for the Play</a> and Set structs:</p><div class="w-embed"><pre><code class="language-markup"><!--
pub struct Play {
  init() {            
    self.playID = TopShot.nextPlayID                       
    // Increment the ID so that it isn't used again
    TopShot.nextPlayID = TopShot.nextPlayID + UInt32(1)
    
    emit PlayCreated(id: self.playID, metadata: metadata)        
  }
}
}--!></code></pre></div><p>At the time, Cadence did not, and still doesn‚Äôt, support private struct definitions. This means that anyone could create an instance of this Play struct or the SetData struct whenever they want. Every initialization would increment the id counter and emit an event, even though these sets and plays that were created were not real sets or plays. Eventually, the field would reach the limit for UInt32 and overflow, which could prevent new plays or sets from being created. This would be quite expensive to exploit, but is still a serious vulnerability that should always be avoided.</p><p>This references an important security aspect of smart contract development that should always be considered, regardless of the contract you are working on. If you have any operations that change important state in the contract, you should always default those operations to being hidden in an admin resource that restricts that functionality to only those who should be able to do it. There are obviously exceptions to this, but they should be carefully considered before committing to.</p><h3>Fifth Improvement: Borrow references to resources instead of loading them from storage</h3><p><strong>FIXED</strong></p><p>The Top Shot contract stores an important resource in a contract field, the Set resource. There are certain functions, including the queryable set metadata functionality that I described above, that need to get information about one of these sets that is stored in the contract. <a href="https://github.com/dapperlabs/nba-smart-contracts/blob/31697fb7ed42b0a15b9e8cb11fa1b8b6f78d3c20/contracts/TopShot.cdc#L798" target="_blank">The solution that we originally used</a> for accessing these sets was to load the whole set from storage, read its fields, and then put it back where it came from.</p><div class="w-embed"><pre><code class="language-markup"><!--
if let setToRead <- TopShot.sets.remove(key: setID) {
   // See if the Play is retired from this Set
   let retired = setToRead.retired[playID]
             
   // Put the Set back in the contract storage
   TopShot.sets[setID] <-! setToRead
             
   // Return the retired status
   return retired
        
}
}--!></code></pre></div><p>This works fine, but it is pretty inefficient. It takes a lot of computational resources to load an object from storage and save it again.</p><p>This coding pattern also caused a problem with the <a href="https://github.com/dapperlabs/nba-smart-contracts/blob/31697fb7ed42b0a15b9e8cb11fa1b8b6f78d3c20/contracts/TopShotShardedCollection.cdc#L106" target="_blank">TopShotShardedCollection.cdc</a> smart contract because when you load a resource from storage, its owner field is set to nil . If you try to access its owner field expecting it to be a certain value (like when you are emitting a Deposit event, for example), it will be nil , even if you plan to put it right back into storage right after withdrawing it like we did in the sharded collection contract.</p><p>The correct solution for this pattern is to borrow a reference to the resource instead. Borrowing a reference only uses only line of code instead of two and is a much more efficient operation:</p><div class="w-embed"><pre><code class="language-markup"><!--
let collectionRef = &self.collections[bucket] as! &TopShot.Collection
}--!></code></pre></div><p>‚Äç</p><h3>Conclusion</h3><p>I hope these suggestions have been useful for some of you! I would like to further reiterate to those of you who want to build NFT projects on Flow to think deeply about what makes your NFTs unique and try to reflect that with unique features in your NFT smart contract. A simple copy and paste of the Top Shot contract will not set you apart from the rest of the pack.</p><p>If you have any comments about improvements you‚Äôd make to the Top Shot contract, or just want to talk smack about the Pacers, please share here or in our Discord! There may be some I am missing and we might even be able to include them in a later version.</p><p>If you have any questions, the entire Flow team, Top Shot team, and community is here to support you! Please do not hesitate to reach out via our Discord server, the Flow Forum, or via an issue in the Top Shot Github repo.</p><p>Are there any other topics or interesting projects that you know would useful to newcomers or that you would like me to write a blog post about? Feel free to comment with your ideas and I might include them in a future post!</p><p>Flow Discord: <a href="https://discord.gg/flow" target="_blank">https://discord.gg/flow</a></p><p>Flow Forum: <a href="https://forum.onflow.org/latest" target="_blank">https://forum.onflow.org</a></p><p>Flow Github: <a href="https://github.com/onflow/flow" target="_blank">https://github.com/onflow/flow</a></p><p>See you next week! üëã</p></div><div class="tags-post-div"><div class="tags-title-14">Tags:</div><div class="w-dyn-list"><div role="list" class="tag-cloud w-dyn-items"><div role="listitem" class="w-dyn-item"><div class="tags-title">Blockchain</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Smart Contracts</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Nba Top Shot</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Dapps</div></div><div role="listitem" class="w-dyn-item"><div class="tags-title">Dapper Labs</div></div></div></div></div></div></div></div></div></div><div class="post-with-text-layout hide"><div class="blog-post-hero-2 no-image wf-section"><div class="post-container w-container"><div><div class="blog-post-meta-data in-post"><div class="blog-post-category">Studio</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">03/30/2021</div></div><div class="main-blog-post-title">Welcoming Animoca, MotoGP, and StarGirl to Flow</div><div class="blog-post-meta-data post"><div class="blog-post-meta-text-data dark">Mik Naayem</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">CBO and Cofounder at Dapper Labs</div></div></div></div></div><div class="blog-post-section wf-section"><div class="container-25 _1280 w-container"><div class="post-info-parent no-img"><div class="post-share-sidebar"><div class="social-share-btn-2 tw"></div><div class="social-share-btn-2 email"></div><div class="share-text">Share</div></div><div class="post-main-info-div"><div class="blog-post-rich-text w-richtext"><p>The rich text element allows you to create and format headings, paragraphs, blockquotes, images, and video all in one place instead of having to add and format them individually. Just double-click and easily create content.</p><ul role="list"><li>Decentralized because you can set up a blockchain system so that every entity can only make changes within its predefined purview. Companies can also use permissionless, permissioned, or hybrid-approach blockchains, allowing for useful trade-offs between network security and system privacy.</li><li>Decentralized because you can set up a blockchain system so that every entity can only make changes within its predefined purview. Companies can also use permissionless, permissioned, or hybrid-approach blockchains, allowing for useful trade-offs between network security and system privacy.</li><li>scscsssc</li></ul><h4>Static and dynamic content editing</h4><blockquote>A rich text element can be used with static or dynamic content. For static content, just drop it into any page and begin editing. For dynamic content, add a<a href="http://www.google.com"> rich text field to any collection</a> and then connect a rich text element to that field in the settings panel. Voila!</blockquote><h4>How to customize formatting for each rich text</h4><p>Headings, paragraphs, blockquotes, figures, images, and figure captions can all be styled after a class is added to the rich text element using the &quot;When inside of&quot; nested selector system.</p></div></div></div></div></div></div><div class="section-32 wf-section"><div class="container-25 _1280 w-container"><div class="title-div-3"><div>Related Content</div></div><div class="w-dyn-list"><div role="list" class="w-dyn-items"><div role="listitem" class="w-dyn-item"><div class="blog-post-parant-div first"><div class="blog-post-info-div"><a href="/engineering-blogs/upgrading-flows-consensus-follower-to-boost-attack-resilience-and-processing-speed" class="blog-post-title">Upgrading Flow&#x27;s Consensus Follower to boost attack resilience and processing speed</a><div class="blog-post-meta-data"><div class="blog-post-meta-text-data">May 30, 2023</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Jordan Schalm</div></div></div></div></div><div role="listitem" class="w-dyn-item"><div class="blog-post-parant-div first"><div class="blog-post-info-div"><a href="/engineering-blogs/jolteon-advancing-flows-consensus-algorithm" class="blog-post-title">Jolteon: Advancing Flow‚Äôs consensus algorithm</a><div class="blog-post-meta-data"><div class="blog-post-meta-text-data">Apr 14, 2023</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Jordan Schalm</div></div></div></div></div><div role="listitem" class="w-dyn-item"><div class="blog-post-parant-div first"><div class="blog-post-info-div"><a href="/engineering-blogs/golang-services-improving-observability" class="blog-post-title">Improving Observability of GoLang Services</a><div class="blog-post-meta-data"><div class="blog-post-meta-text-data">Jan 31, 2023</div><div class="small-dot-sep"></div><div class="blog-post-meta-text-data">Alexey Ivanov</div></div></div></div></div></div></div></div></div></div><div class="section footer wf-section"><div class="footer-div"><div class="join-text-2 no-hover">Join Flow on</div><a href="https://twitter.com/flow_blockchain" target="_blank" class="join-text-2">Twitter</a><a href="https://discord.com/invite/J6fFnh2xx6" target="_blank" class="join-text-2">Discord</a><a href="https://flow.com/" target="_blank" class="join-text-2">flow.com</a></div></div><div class="new-footer wf-section"><div class="container w-container"><div class="w-layout-grid _3-footer-grid"><div><a id="w-node-ec243fb8-8059-5bdb-528d-ce0b082ca18b-082ca187" href="/" class="footer-logo-link w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63ce603ae36f46f6bb67e51e_flow-logo.svg" loading="lazy" alt="flow logo" class="footer-logo-img"/></a><div class="footer-social-icons"><a href="https://twitter.com/flow_blockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec770abbeba426e358f76_Twitter%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://www.instagram.com/flowblockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec770799e2958d15306a0_Instagram%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://www.youtube.com/@FlowBlockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec77005a49eaba248e147_YouTube%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://t.me/flow_blockchain" target="_blank" class="footer-social-icon w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63cec770b75d5482a08014db_Telegram%20-%20Negative.svg" loading="lazy" alt="social icon"/></a><a href="https://discord.com/invite/J6fFnh2xx6" target="_blank" class="footer-social-icon last w-inline-block"><img src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/63d0398494fe5d96e72f4cc0_Social%20Icon.svg" loading="lazy" alt="social icon"/></a></div></div><div id="w-node-_843ebe60-d3a2-032c-780e-737a5989cba0-082ca187"><div class="footer-column-header">Start Building</div><a href="https://developers.flow.com/" target="_blank" class="new-footer-link">Developer portal</a><a href="https://github.com/onflow" target="_blank" class="new-footer-link">GitHub</a></div><div id="w-node-ec243fb8-8059-5bdb-528d-ce0b082ca19f-082ca187"><div class="footer-column-header">Flow</div><a href="https://docs.google.com/forms/d/e/1FAIpQLSer5ZX0pRWsXF0U0bsgW4Zo8Pmlw0V927ZydDq_ej-qyIJ9_A/viewform" target="_blank" class="new-footer-link">Business Development</a><a href="https://flow.com/node-operation" target="_blank" class="new-footer-link">Node Operation</a><a href="/token-distribution" class="new-footer-link">Token Distribution</a><a href="/mediakit" class="new-footer-link">Media Kit</a><a href="/careers" class="new-footer-link">Careers</a><a href="/faq" class="new-footer-link">FAQ</a></div><div id="w-node-ec243fb8-8059-5bdb-528d-ce0b082ca198-082ca187"><div class="footer-column-header">Get Connected</div><a href="https://port.onflow.org/" target="_blank" class="new-footer-link">Flow Port</a><a href="https://www.flowverse.co/" target="_blank" class="new-footer-link">Flowverse</a></div></div><div class="div-block-129"><div class="footer-copyright">¬© 2023 All Rights Reserved</div></div></div></div><script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=5f734f4dbd95382f4fdfa0ea" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="https://assets-global.website-files.com/5f734f4dbd95382f4fdfa0ea/js/webflow.2724f1538.js" type="text/javascript"></script><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NHJB3BPPXG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NHJB3BPPXG');
</script>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PWSGFLB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --><script src="../../cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="../../cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/unescaped-markup/prism-unescaped-markup.min.js"></script></body>
<!-- Mirrored from flow.com/engineering-blogs/what-ive-learned-in-the-year-since-i-wrote-the-nba-top-shot-smart-contracts by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 22 Jul 2023 16:27:26 GMT -->
</html>